<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Diagramas de Contexto DFD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.29.2/cytoscape.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #cy {
            width: 800px;
            height: 600px;
            border: 1px solid #ccc;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }

        button {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>Generador de Diagramas de Contexto DFD</h1>
    <textarea id="input" placeholder="Ingrese la descripción del diagrama aquí..."></textarea>
    <button type="button" onclick="generateDiagram()">Generar Diagrama</button>
    <div id="cy"></div>

    <script>
        let cy;

        function initCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(id)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'text-wrap': 'wrap',
                            'text-max-width': '80px',
                            /* 'font-size': '10rem', */
                        }
                    },
                    {
                        selector: 'node[type="process"]',
                        style: {
                            'label': 'data(id)',
                            'shape': 'ellipse',
                            'background-color': '#FFB3BA',
                            'width': '120px',
                            'height': '120px',
                            'text-max-width': '100px',
                            /* 'text-overflow-wrap': 'anywhere' */ //Se usa para cuando el texto se desborda de los nodos, pero quita los espacios intermedios
                        }
                    },
                    {
                        selector: 'node[type="entity"]',
                        style: {
                            'label': 'data(id)',
                            'shape': 'round-rectangle',
                            'background-color': '#BAFFC9',
                            'width': '140px',
                            'height': '70px',
                            'text-max-width': '130px',
                            /* 'text-overflow-wrap': 'anywhere' */ //Se usa para cuando el texto se desborda de los nodos, pero quita los espacios intermedios
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 1,
                            'label': 'data(label)',
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle',
                            'font-size': '10px',
                            'text-rotation': 'autorotate',
                            'text-wrap': 'wrap',
                            'text-max-width': '80px',
                            'source-endpoint': 'outside-to-node-or-label',
                            'target-endpoint': 'outside-to-node-or-label',
                            'text-background-color': 'white',
                            'text-background-opacity': 1,
                            'text-background-padding': '2px',
                            'control-point-distances': function (ele) {
                                console.log("ele: ", ele.data());

                                let sameNodesCount = parseInt(ele.data('sameNodesCount'));
                                let id = parseInt(ele.id());
                                let offset = 0;
                                console.log("30 * sameNodesCount", 30 * sameNodesCount);
                                console.log("-1 ** id * 30", (-1) ** id * 30);

                                if(sameNodesCount > 1) {
                                    offset = 30 * sameNodesCount + (-1) ** id * 30;
                                }else{
                                    offset = 30 * sameNodesCount;
                                }
                                console.log("offset: ", offset);
                                return offset;
                            },
                        }
                    }
                ],
            });
        }

        function generateDiagram() {
            const input = document.getElementById('input').value;
            const lines = input.split('\n');

            cy.elements().remove();

            // Agregar el proceso principal (sistema)
            cy.add({ data: { id: 'Sistema', type: 'process' } });

            let edgeCounter = 0;
            let edgeCounts = {};

            // Primer pase para contar las conexiones source-target
            lines.forEach(line => {
                const parts = line.split('->');
                if (parts.length === 3) {
                    const [source, label, target] = parts.map(p => p.trim());

                    const edgeKey = `${source}->${target}`;
                    if (!edgeCounts[edgeKey]) {
                        edgeCounts[edgeKey] = 0;
                    }
                    edgeCounts[edgeKey]++;
                }
            });

            // Segundo pase para agregar elementos y totalSameNodesCount
            lines.forEach(line => {
                const parts = line.split('->');
                if (parts.length === 3) {
                    const [source, label, target] = parts.map(p => p.trim());

                    if (!cy.getElementById(source).length) {
                        cy.add({ data: { id: source, type: 'entity' } });
                    }
                    if (!cy.getElementById(target).length) {
                        cy.add({ data: { id: target, type: 'entity' } });
                    }

                    edgeCounter++;

                    const edgeKey = `${source}->${target}`;

                    cy.add({
                        data: {
                            id: edgeCounter,
                            source: source,
                            target: target,
                            label: label,
                            sameNodesCount: edgeCounts[edgeKey],
                            totalSameNodesCount: edgeCounts[edgeKey]
                        }
                    });
                }
            });

            cy.layout({
                name: 'concentric',
                fit: true,
                padding: 50,
                startAngle: Math.PI / 4,
                clockwise: true,
                equidistant: false,
                minNodeSpacing: 150,
                avoidOverlap: true,
                nodeDimensionsIncludeLabels: true,
                concentric: function (node) {
                    return node.data('type') === 'process' ? 2 : 1;
                },
                levelWidth: function () { return 1; }
            }).run();
        }

        document.addEventListener('DOMContentLoaded', initCytoscape);
    </script>
</body>

</html>